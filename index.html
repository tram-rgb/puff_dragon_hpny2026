<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Puff Dragon AR</title>

<style>
html,body{
margin:0;
padding:0;
background:#000;
overflow:hidden;
height:100%;
font-family:system-ui;
}

.hidden{display:none!important;}

#introOverlay{
position:fixed;
inset:0;
background:#fff;
z-index:9999;
display:flex;
align-items:center;
justify-content:center;
}

#exploreBtn{
position:absolute;
bottom:60px;
left:50%;
transform:translateX(-50%);
padding:14px 28px;
background:#fa213f;
color:#fff;
border:none;
border-radius:12px;
font-weight:800;
font-size:18px;
cursor:pointer;
}

#app{display:none;}

#camera{
position:fixed;
inset:0;
width:100vw;
height:100vh;
object-fit:cover;
z-index:1;
}

#camera.mirror{
transform:scaleX(-1);
}

#puff{
position:fixed;
left:50%;
top:70%;
width:420px;
aspect-ratio:1/1;
transform:translate(-50%,-50%) scale(1.4);
transform-origin:center;
z-index:2;
pointer-events:auto;
touch-action:none;
object-fit:contain;
}

#ui{
position:fixed;
bottom:0;
left:0;
right:0;
padding:12px;
display:flex;
flex-direction:column;
gap:8px;
background:linear-gradient(to top,rgba(0,0,0,.7),transparent);
z-index:10;
}

.ui-row{
display:flex;
gap:8px;
justify-content:center;
flex-wrap:wrap;
}

button{
border:none;
border-radius:10px;
padding:8px 12px;
font-weight:800;
cursor:pointer;
}

#start{background:#fa213f;color:#fff;}
.secondary{background:rgba(255,255,255,.15);color:#fff;}
#capture{background:#fff100;color:#000;font-weight:900;}

#capturedPanel{
position:fixed;
right:20px;
top:20px;
width:220px;
max-height:360px;
background:rgba(0,0,0,.7);
border-radius:12px;
overflow:auto;
z-index:20;
padding:10px;
display:none;
}

.capThumb{
width:100%;
margin-bottom:8px;
border-radius:8px;
overflow:hidden;
}

.capThumb img{
width:100%;
display:block;
}
</style>
</head>

<body>

<div id="introOverlay">
<button id="exploreBtn">Explore</button>
</div>

<div id="app">
<video id="camera" autoplay playsinline muted></video>
<video id="puff" autoplay playsinline muted loop></video>
<div id="capturedPanel"></div>

<div id="ui">
<div class="ui-row">
<button id="start">Start AR</button>
<button id="flip" class="secondary">Flip</button>
<button id="mirror" class="secondary">Mirror</button>
</div>
<div class="ui-row">
<button id="photoboothToggle" class="secondary">Photobooth OFF</button>
<button id="capture">Puff It!</button>
</div>
</div>

</div>

<script>
const camera=document.getElementById("camera");
const puff=document.getElementById("puff");
const startBtn=document.getElementById("start");
const flipBtn=document.getElementById("flip");
const mirrorBtn=document.getElementById("mirror");
const captureBtn=document.getElementById("capture");
const exploreBtn=document.getElementById("exploreBtn");
const introOverlay=document.getElementById("introOverlay");
const app=document.getElementById("app");
const photoboothToggle=document.getElementById("photoboothToggle");
const capturedPanel=document.getElementById("capturedPanel");

let stream=null;
let facing="environment";
let mirror=false;
let photobooth=false;
let captures=[];

/* INTRO */
exploreBtn.onclick=()=>{
introOverlay.style.display="none";
app.style.display="block";
};

/* CAMERA */
async function startCamera(){
if(stream)stream.getTracks().forEach(t=>t.stop());
stream=await navigator.mediaDevices.getUserMedia({
video:{facingMode:facing}
});
camera.srcObject=stream;
await camera.play();
}
startBtn.onclick=startCamera;

flipBtn.onclick=()=>{
facing=facing==="environment"?"user":"environment";
startCamera();
};

mirrorBtn.onclick=()=>{
mirror=!mirror;
camera.classList.toggle("mirror",mirror);
};

/* PUFF SOURCE */
puff.src="puff.webm";

/* TRANSFORM ENGINE */
let state={x:50,y:70,scale:1.4,rotation:0};
let rotateMode=false;

window.addEventListener("keydown",e=>{
if(e.key.toLowerCase()==="r") rotateMode=true;
});
window.addEventListener("keyup",e=>{
if(e.key.toLowerCase()==="r") rotateMode=false;
});

function updatePuff(){
puff.style.left=state.x+"%";
puff.style.top=state.y+"%";
puff.style.transform=
`translate(-50%,-50%) scale(${state.scale}) rotate(${state.rotation}deg)`;
}
updatePuff();

let pointers=new Map();
let gesture=null;

puff.addEventListener("pointerdown",e=>{
pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
puff.setPointerCapture(e.pointerId);

if(pointers.size===2){
const pts=[...pointers.values()];
gesture={
dist:distance(pts[0],pts[1]),
angle:angle(pts[0],pts[1]),
baseScale:state.scale,
baseRot:state.rotation
};
}
});

puff.addEventListener("pointermove",e=>{
if(!pointers.has(e.pointerId))return;
pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});

if(pointers.size===1){
const p=[...pointers.values()][0];

if(rotateMode){
const cx=window.innerWidth/2;
const cy=window.innerHeight/2;
state.rotation=Math.atan2(p.y-cy,p.x-cx)*180/Math.PI;
}else{
state.x=(p.x/window.innerWidth)*100;
state.y=(p.y/window.innerHeight)*100;
}
updatePuff();
}

if(pointers.size===2 && gesture){
const pts=[...pointers.values()];
const newDist=distance(pts[0],pts[1]);
const newAngle=angle(pts[0],pts[1]);
state.scale=gesture.baseScale*(newDist/gesture.dist);
state.rotation=gesture.baseRot+(newAngle-gesture.angle);
updatePuff();
}
});

puff.addEventListener("pointerup",e=>{
pointers.delete(e.pointerId);
if(pointers.size<2)gesture=null;
});

function distance(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}
function angle(a,b){return Math.atan2(b.y-a.y,b.x-a.x)*180/Math.PI;}

/* CAPTURE */
function capture(){
const dpr=window.devicePixelRatio||1;
const W=window.innerWidth*dpr;
const H=window.innerHeight*dpr;

const canvas=document.createElement("canvas");
canvas.width=W;
canvas.height=H;
const ctx=canvas.getContext("2d");

if(mirror){
ctx.translate(W,0);
ctx.scale(-1,1);
}

ctx.drawImage(camera,0,0,W,H);

const rect=puff.getBoundingClientRect();
const centerX=(rect.left+rect.width/2)*dpr;
const centerY=(rect.top+rect.height/2)*dpr;
const drawWidth=rect.width*dpr;
const drawHeight=rect.height*dpr;

ctx.save();
ctx.translate(centerX,centerY);
ctx.rotate(state.rotation*Math.PI/180);
ctx.drawImage(
puff,
-drawWidth/2,
-drawHeight/2,
drawWidth,
drawHeight
);
ctx.restore();

canvas.toBlob(blob=>{
if(!photobooth){
const url=URL.createObjectURL(blob);
const a=document.createElement("a");
a.href=url;
a.download="Puff_Dragon.png";
a.click();
}else{
const url=URL.createObjectURL(blob);
captures.push(url);
renderCaptures();
}
});
}
captureBtn.onclick=capture;

/* PHOTOBOOTH */
photoboothToggle.onclick=()=>{
photobooth=!photobooth;
photoboothToggle.textContent=
photobooth?"Photobooth ON":"Photobooth OFF";
capturedPanel.style.display=photobooth?"block":"none";
};

function renderCaptures(){
capturedPanel.innerHTML="";
captures.forEach(url=>{
const div=document.createElement("div");
div.className="capThumb";
div.innerHTML=`<img src="${url}">`;
capturedPanel.appendChild(div);
});
}
</script>
</body>
</html>
